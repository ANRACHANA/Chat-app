<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chat System with Role & Reply (Mobile Friendly)</title>
<style>
 body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
  margin: 0; padding: 10px;
  box-sizing: border-box;
  color: #333;
}

#login-section, #chat-section {
  max-width: 900px;
  margin: auto;
  background: white;
  border-radius: 12px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.12);
  padding: 20px;
  transition: box-shadow 0.3s ease;
}

#login-section:hover, #chat-section:hover {
  box-shadow: 0 12px 25px rgba(0,0,0,0.18);
}

h2 {
  font-weight: 700;
  color: #1e3a8a;
  margin-bottom: 20px;
  letter-spacing: 1px;
  text-align: center;
}

/* Sidebar user list */
#sidebar {
  width: 280px;
  background: #e0e7ff;
  border-radius: 12px;
  padding: 15px;
  box-shadow: inset 0 0 15px rgba(0,0,0,0.03);
  overflow-y: auto;
  order: 2;
}

#sidebar h3 {
  margin-top: 0;
  margin-bottom: 15px;
  font-weight: 700;
  color: #4338ca;
  text-align: center;
}

.user-item {
  padding: 10px 15px;
  margin-bottom: 10px;
  background: white;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  color: #374151;
  user-select: none;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  transition: background-color 0.3s, box-shadow 0.3s, color 0.3s;
  text-align: center;
}

.user-item:hover {
  background: #4338ca;
  color: white;
  box-shadow: 0 4px 12px rgba(67,56,202,0.5);
}

.user-item.selected {
  background: #312e81;
  color: white;
  font-weight: 700;
  box-shadow: 0 4px 15px rgba(49,46,129,0.8);
}

/* Main chat area */
#main-chat {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  padding-right: 15px;
  order: 1;
}

/* Chat messages box */
#chat-messages {
  width: 100%;
  max-width: 100%;
  height: 500px;
  overflow-y: auto;
  padding: 15px;
  border-radius: 12px;
  background: #fefefe;
  box-shadow: 0 6px 15px rgba(0,0,0,0.06);
  font-size: 16px;
  line-height: 1.4;
  display: flex;
  flex-direction: column;
}

/* Messages */
.message {
  display: inline-block;
  max-width: 75%;
  padding: 12px 16px;
  margin: 6px 0;
  border-radius: 18px;
  white-space: pre-line;
  word-break: break-word;
  overflow-wrap: break-word;
  font-weight: 500;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  cursor: default;
  user-select: text;
  transition: background-color 0.3s ease;
}

/* Sent messages */
.message.sent {
  align-self: flex-end;
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: white;
  border-radius: 18px 18px 0 18px;
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.5);
}

/* Received messages */
.message.received {
  align-self: flex-start;
  background: #e0e7ff;
  color: #1e293b;
  border-radius: 18px 18px 18px 0;
  box-shadow: 0 2px 8px rgba(67, 56, 202, 0.25);
}

/* Reply preview inside message */
.message .reply-preview {
  font-size: 0.8em;
  color: #4b5563;
  border-left: 3px solid #4338ca;
  padding-left: 8px;
  margin-bottom: 6px;
  user-select: none;
}

/* Input container */
#chat-input-container {
  display: flex;
  margin-top: 15px;
  gap: 12px;
}

#chat-input {
  flex-grow: 1;
  padding: 12px 16px;
  font-size: 1.1em;
  border-radius: 12px;
  border: 1px solid #cbd5e1;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
  transition: border-color 0.3s ease;
}

#chat-input:focus {
  border-color: #4338ca;
  outline: none;
  box-shadow: 0 0 6px #4338caaa;
}

#send-button {
  width: 90px;
  font-size: 1em;
  padding: 12px;
  border-radius: 12px;
  cursor: pointer;
  background: linear-gradient(135deg, #4338ca, #6d28d9);
  color: white;
  border: none;
  font-weight: 700;
  box-shadow: 0 4px 12px rgba(109, 40, 217, 0.7);
  transition: background 0.3s ease;
}

#send-button:hover:not(:disabled) {
  background: linear-gradient(135deg, #6d28d9, #4338ca);
  box-shadow: 0 6px 15px rgba(109, 40, 217, 0.9);
}

#send-button:disabled {
  background: #a5b4fc;
  cursor: not-allowed;
  box-shadow: none;
}

#logout-button {
  margin-top: 20px;
  background: #ef4444;
  color: white;
  border: none;
  padding: 12px;
  width: 100%;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 700;
  box-shadow: 0 4px 14px rgba(239, 68, 68, 0.75);
  transition: background 0.3s ease;
}

#logout-button:hover {
  background: #dc2626;
}

/* Login form inputs */
#login-section > div {
  margin-bottom: 20px;
}

label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  color: #374151;
}

input[type="text"], input[type="email"], input[type="password"], input[type="file"] {
  width: 100%;
  padding: 12px 15px;
  box-sizing: border-box;
  border-radius: 12px;
  border: 1px solid #cbd5e1;
  font-size: 1em;
  transition: border-color 0.3s ease;
}

input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, input[type="file"]:focus {
  border-color: #4338ca;
  outline: none;
  box-shadow: 0 0 8px #4338caaa;
}

button {
  background: linear-gradient(135deg, #4338ca, #6d28d9);
  color: white;
  border: none;
  padding: 14px;
  width: 100%;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 700;
  box-shadow: 0 5px 15px rgba(109, 40, 217, 0.8);
  transition: background 0.3s ease;
}

button:hover:not(:disabled) {
  background: linear-gradient(135deg, #6d28d9, #4338ca);
  box-shadow: 0 7px 18px rgba(109, 40, 217, 1);
}

button:disabled {
  background: #a5b4fc;
  cursor: not-allowed;
  box-shadow: none;
}

/* Responsive for smaller devices */
@media screen and (max-width: 700px) {
  #chat-section {
    flex-direction: column;
    height: auto;
  }

  #sidebar {
    width: 100%;
    order: 2;
    border-left: none;
    border-top: 1px solid #cbd5e1;
    max-height: 180px;
    padding: 8px;
    border-radius: 12px 12px 0 0;
  }

  #sidebar .user-item {
    font-size: 1em;
    padding: 10px 12px;
    margin-bottom: 10px;
  }

  #main-chat {
    order: 1;
    padding-right: 0;
    padding-bottom: 20px;
  }

  #chat-messages {
    max-height: 350px;
    height: 350px;
  }

  #chat-input-container {
    flex-direction: column;
  }

  #send-button {
    width: 100%;
  }
}

</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- jsQR for QR code scanning -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

</head>
<body>

<div id="login-section">
  <h2>Login</h2>

  <div id="user-login" style="display:none;">
    <label for="customer-id-input">Customer ID (from QR)</label>
    <input type="text" id="customer-id-input" placeholder="Scan or enter Customer ID" />
    <input type="file" id="uploadQRInput" accept="image/*" />
    <button id="user-login-btn">Login as User</button>
  </div>

  <div id="admin-login">
    <label for="admin-email">Admin Email</label>
    <input type="email" id="admin-email" placeholder="Enter admin email" />
    <label for="admin-password">Password</label>
    <input type="password" id="admin-password" placeholder="Enter password" />
    <button id="admin-login-btn">Login as Admin</button>
  </div>

  <p style="margin-top:10px; font-size: 0.9em;">
    <a href="#" id="switch-to-user">Login as User</a> |
    <a href="#" id="switch-to-admin" style="display:none;">Login as Admin</a>
  </p>
</div>

<div id="chat-section" style="display:none;">
  <div id="main-chat">
    <h2>Chat Room</h2>
    <div id="chat-messages"><p style="color:#64748b; text-align:center; margin-top: 30px;">No messages yet</p></div>
    <div id="chat-input-container">
      <input type="text" id="chat-input" placeholder="Write a message..." />
      <button id="send-button" disabled>Send</button>
    </div>
    <button id="logout-button">Logout</button>
  </div>
  <div id="sidebar" style="display:none;">
    <h3>Users</h3>
    <div id="user-list">Loading users...</div>
  </div>
</div>

<script>
  // Firebase Config - replace with your Firebase project config
  const firebaseConfig = {
    apiKey: "AIzaSyD61vUNw4gFmzR4zfS8s7FVIzsJe9nXQHQ",
    authDomain: "home-invoice-e1f43.firebaseapp.com",
    projectId: "home-invoice-e1f43"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const loginSection = document.getElementById('login-section');
  const chatSection = document.getElementById('chat-section');
  const chatMessages = document.getElementById('chat-messages');
  const chatInput = document.getElementById('chat-input');
  const sendButton = document.getElementById('send-button');
  const logoutButton = document.getElementById('logout-button');
  const sidebar = document.getElementById('sidebar');
  const userListDiv = document.getElementById('user-list');

  const userLoginDiv = document.getElementById('user-login');
  const adminLoginDiv = document.getElementById('admin-login');
  const switchToUserLink = document.getElementById('switch-to-user');
  const switchToAdminLink = document.getElementById('switch-to-admin');

  const customerIdInput = document.getElementById('customer-id-input');
  const uploadQRInput = document.getElementById('uploadQRInput');

  const adminEmailInput = document.getElementById('admin-email');
  const adminPasswordInput = document.getElementById('admin-password');

  let currentUser = null;
  let unsubscribeMessages = null;
  let selectedUserId = null;

  // Switch login forms
  switchToUserLink.onclick = (e) => {
    e.preventDefault();
    userLoginDiv.style.display = 'block';
    adminLoginDiv.style.display = 'none';
    switchToUserLink.style.display = 'none';
    switchToAdminLink.style.display = 'inline';
  };
  switchToAdminLink.onclick = (e) => {
    e.preventDefault();
    userLoginDiv.style.display = 'none';
    adminLoginDiv.style.display = 'block';
    switchToUserLink.style.display = 'inline';
    switchToAdminLink.style.display = 'none';
  };

  // User login with Customer ID
  document.getElementById('user-login-btn').onclick = () => {
    const id = customerIdInput.value.trim();
    if (!id) {
      alert('សូមបញ្ចូល Customer ID');
      return;
    }
    currentUser = { id, role: 'user' };
    selectedUserId = null;
    openChat();
  };

  // Admin login with Firebase Auth
  document.getElementById('admin-login-btn').onclick = async () => {
    const email = adminEmailInput.value.trim();
    const password = adminPasswordInput.value.trim();
    if (!email || !password) {
      alert('សូមបញ្ចូលអ៊ីមែល និងពាក្យសម្ងាត់');
      return;
    }
    try {
      const userCredential = await auth.signInWithEmailAndPassword(email, password);
      currentUser = { id: userCredential.user.uid, role: 'admin', email };
      selectedUserId = null;
      openChat();
      loadUserList();
    } catch (e) {
      alert('Login failed: ' + e.message);
    }
  };

  // Enable send button only if input has text
  chatInput.addEventListener('input', () => {
    sendButton.disabled = chatInput.value.trim() === '';
  });

  logoutButton.onclick = () => {
    if (currentUser && currentUser.role === 'admin') {
      auth.signOut();
    }
    currentUser = null;
    selectedUserId = null;
    if (unsubscribeMessages) unsubscribeMessages();
    chatMessages.innerHTML = '<p style="color:#64748b; text-align:center; margin-top: 30px;">No messages yet</p>';
    userListDiv.innerHTML = '';
    loginSection.style.display = 'block';
    chatSection.style.display = 'none';
    sidebar.style.display = 'none';
    customerIdInput.value = '';
    adminEmailInput.value = '';
    adminPasswordInput.value = '';
    sendButton.disabled = true;
  };

  function openChat() {
    loginSection.style.display = 'none';
    chatSection.style.display = 'flex';
    chatInput.value = '';
    sendButton.disabled = true;
    chatMessages.innerHTML = '<p style="color:#64748b; text-align:center; margin-top: 30px;">No messages yet</p>';
    if (currentUser.role === 'admin') {
      sidebar.style.display = 'block';
    } else {
      sidebar.style.display = 'none';
    }
    listenForMessages();
  }

  // Listen messages filtered by role and selected user
  function listenForMessages() {
    if (unsubscribeMessages) unsubscribeMessages();

    unsubscribeMessages = db.collection('messages')
      .orderBy('timestamp')
      .limit(100)
      .onSnapshot(snapshot => {
        chatMessages.innerHTML = '';

        if (snapshot.empty) {
          chatMessages.innerHTML = '<p style="color:#64748b; text-align:center; margin-top: 30px;">No messages yet</p>';
          return;
        }

        snapshot.forEach(doc => {
          const msg = doc.data();

          // Filtering messages by role
          if (currentUser.role === 'user') {
            // Show messages sent by or received by this user
            if (msg.senderId !== currentUser.id && !(msg.senderRole === 'admin' && msg.receiverId === currentUser.id)) {
              return;
            }
          } else if (currentUser.role === 'admin') {
            if (!selectedUserId) return;
            if (msg.senderId !== selectedUserId && msg.receiverId !== selectedUserId) return;
          }

          const div = document.createElement('div');
          div.classList.add('message');

          // Sent or received style
          if (msg.senderId === currentUser.id) {
            div.classList.add('sent');
          } else {
            div.classList.add('received');
          }

          // Dynamic background opacity by text length (0.3 to 0.8)
          let length = Math.min(msg.text.length, 100);
          let opacity = 0.3 + (length / 100) * 0.5;

          if (div.classList.contains('sent')) {
            div.style.backgroundColor = `rgba(0, 132, 255, ${opacity.toFixed(2)})`;
            div.style.color = 'white';
          } else {
            div.style.backgroundColor = `rgba(241, 240, 240, ${opacity.toFixed(2)})`;
            div.style.color = 'black';
          }

          div.textContent = msg.text;
          chatMessages.appendChild(div);
        });

        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, error => {
        console.error('Error fetching messages:', error);
        chatMessages.innerHTML = '<p style="color:#ef4444; text-align:center; margin-top: 30px;">Failed to load messages</p>';
      });
  }

  // Load user list for admin
  async function loadUserList() {
    userListDiv.innerHTML = '<em>Loading users...</em>';
    try {
      const snapshot = await db.collection('messages')
        .orderBy('timestamp', 'desc')
        .limit(500)
        .get();

      const usersSet = new Set();
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.senderRole === 'user') usersSet.add(data.senderId);
        if (data.receiverRole === 'user' && data.receiverId) usersSet.add(data.receiverId);
      });

      if (usersSet.size === 0) {
        userListDiv.innerHTML = '<em>No users found.</em>';
        return;
      }

      userListDiv.innerHTML = '';
      usersSet.forEach(uid => {
        const div = document.createElement('div');
        div.textContent = uid;
        div.classList.add('user-item');
        div.onclick = () => selectUser(uid, div);
        userListDiv.appendChild(div);
      });
    } catch (e) {
      userListDiv.innerHTML = `<em>Error loading users: ${e.message}</em>`;
    }
  }

  // Select user to chat in admin sidebar
  function selectUser(uid, div) {
    selectedUserId = uid;
    Array.from(userListDiv.children).forEach(child => child.classList.remove('selected'));
    div.classList.add('selected');
    chatMessages.innerHTML = '<p style="color:#64748b; text-align:center; margin-top: 30px;">Loading messages...</p>';
    listenForMessages();
  }

  // Send message
  sendButton.onclick = async () => {
    const text = chatInput.value.trim();
    if (!text) return;

    if (currentUser.role === 'admin' && !selectedUserId) {
      alert('សូមជ្រើសរើស User មុនពេលផ្ញើសារ!');
      return;
    }

    sendButton.disabled = true;

    try {
      let receiverId = null;
      let receiverRole = null;

      if (currentUser.role === 'admin') {
        receiverId = selectedUserId;
        receiverRole = 'user';
      } else {
        receiverId = null; // user messages implicitly to admin
        receiverRole = 'admin';
      }

      await db.collection('messages').add({
        senderId: currentUser.id,
        senderRole: currentUser.role,
        receiverId,
        receiverRole,
        text,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      chatInput.value = '';
      sendButton.disabled = true;
    } catch (e) {
      alert('Error sending message: ' + e.message);
    } finally {
      sendButton.disabled = false;
    }
  };

  // QR code scan from uploaded image (optional)
  uploadQRInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(ev) {
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        if (code) {
          customerIdInput.value = code.data;
          alert('QR Code detected: ' + code.data);
        } else {
          alert('No QR code found in the image.');
        }
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });

  // On page load, show user login by default
  userLoginDiv.style.display = 'block';
  adminLoginDiv.style.display = 'none';

</script>

</body>
</html>
